version: '3.8'

services:
  # ==========================================
  # 1. SurrealDB Database
  # Accessed via https://db.gemmavue.xyz
  # ==========================================
  surrealdb:
    image: surrealdb/surrealdb:latest
    container_name: gemmavue-surrealdb
    restart: unless-stopped
    command: start --log info --user ${SURREAL_USER} --pass ${SURREAL_PASS} file://data/database.db
    environment:
      - SURREAL_USER=${SURREAL_USER:-root}
      - SURREAL_PASS=${SURREAL_PASS:-root}
    volumes:
      - surreal-data:/data
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gemmavue-db.rule=Host(`db.gemmavue.xyz`)"
      - "traefik.http.routers.gemmavue-db.entrypoints=websecure"
      - "traefik.http.routers.gemmavue-db.tls.certresolver=letsencrypt"
      - "traefik.http.services.gemmavue-db.loadbalancer.server.port=8000"

  # ==========================================
  # 2. Surrealist UI (Admin Panel)
  # Accessed via https://admin.gemmavue.xyz
  # ==========================================
  surrealist:
    image: surrealdb/surrealist:latest
    container_name: gemmavue-surrealist
    restart: unless-stopped
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gemmavue-admin.rule=Host(`admin.gemmavue.xyz`)"
      - "traefik.http.routers.gemmavue-admin.entrypoints=websecure"
      - "traefik.http.routers.gemmavue-admin.tls.certresolver=letsencrypt"
      - "traefik.http.services.gemmavue-admin.loadbalancer.server.port=80"
  
  # ==========================================
  # 3. GemmaVue App (Frontend)
  # Accessed via https://gemmavue.xyz
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      # Important: Pass env vars as ARGS for the build time
      args:
        - VITE_API_KEY=${VITE_API_KEY}
        - VITE_SURREAL_URL=${VITE_SURREAL_URL:-https://db.gemmavue.xyz/rpc}
        - VITE_SURREAL_NS=${VITE_SURREAL_NS:-gemmavue}
        - VITE_SURREAL_DB=${VITE_SURREAL_DB:-clinical}
        - VITE_SURREAL_USER=${SURREAL_USER:-root}
        - VITE_SURREAL_PASS=${SURREAL_PASS:-root}
    container_name: gemmavue-app
    restart: unless-stopped
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gemmavue-app.rule=Host(`gemmavue.xyz`)"
      - "traefik.http.routers.gemmavue-app.entrypoints=websecure"
      - "traefik.http.routers.gemmavue-app.tls.certresolver=letsencrypt"
      - "traefik.http.services.gemmavue-app.loadbalancer.server.port=80"

volumes:
  surreal-data:

networks:
  dokploy-network:
    external: true
